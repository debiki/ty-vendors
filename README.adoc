In `source/` you'll find an OpenResty source release.
It's unzipped so it's simpler to `git diff` changes
between OpenResty versions.

Why is this a submodule? So can squash, if the Git history gets too large.
So the main repo can stay somewhat small. Or if changing from OpenResty to
something else — then, would be a bit weird to keep all OpenResty Git history,
in the main repo, although no longer in use.


### Upgrading OpenResty

To upgrade OpenResty, 1) download a new version of OpenResty,
2) get the PGP key, 3) check the PGP signature,
4) overwrite `source/` with the new version,
5) Git-commit the changes, rebuild and test.


#### 1) Download OpenResty

Download via: https://openresty.org/en/download.html, _for example_ v1.19.3.1:

  cd images/web/openresty/  # this dir
  wget https://openresty.org/download/openresty-1.19.3.1.tar.gz
  wget https://openresty.org/download/openresty-1.19.3.1.tar.gz.asc


#### 2) Get the PGP key and check the signature

Getting the PGP key is a bit messy. The download page reads: (as of 2020-12-13)

> All the releases are signed by the public PGP key A0E98066 of Yichun Zhang

##### You have the key already?

First, let's check if you have that key installed already:

  # Bad idea — looking only at the last 32 bits:
  #gpg --list-keys A0E98066

  # Better idea — looking at the last 64 bits:
  gpg --list-keys 0xB550E09EA0E98066

The full key id is apparently `25451EB088460026195BD62CB550E09EA0E98066`.

##### Fetch key from keyserver

If the key is missing, get the key. However, the instructions on the OpenResty website
mention only the last 32 bits of the key, but it's
possible to generate fake keys with matching last 32 bits. In fact,
someone did (apparently in order to kindly show that it's possible) — look here:

```
$ gpg --keyserver keyserver.ubuntu.com --keyserver-options timeout=10 --recv-key A0E98066
gpg: key A84A5A40A0E98066: public key "Totally Legit Signing Key <mallory@example.org>" imported
gpg: Total number processed: 1
gpg:               imported: 1
```

So don't do this:

  # Bad idea:
  # gpg --keyserver pgpkeys.mit.edu --keyserver-options timeout=10 --recv-key A0E98066

Instead, specify 64 bits:

  gpg --keyserver keyserver.ubuntu.com --keyserver-options timeout=10 --recv-key 0xB550E09EA0E98066

(Why `pgpkeys.mit.edu`? Apparently we can use that MIT keyserver,
see this Git issue and commit:
https://github.com/openresty/openresty.org/issues/30,
https://github.com/openresty/openresty.org/pull/32/files,
and this related blog post:
https://asterisk-pbx.ru/wiki/blog/openresty.
There are some well-known keyservers, e.g. `pgpkeys.mit.edu`,
`hkp://keyserver.ubuntu.com:80`, `ha.pool.sks-keyservers.net`.
Edit: Seems the MIT keyserver is gone (at least temporarily, 2021-08-26)
— but you can use keyserver.ubuntu.com instead?)


Anyway, when importing the key (`..--recv-key` above), you'll see something like:

  gpg: key B550E09EA0E98066: 1 signature not checked due to a missing key
  gpg: /home/user/.gnupg/trustdb.gpg: trustdb created
  gpg: key B550E09EA0E98066: public key "Yichun Zhang (agentzh) <agentzh@gmail.com>" imported
  gpg: no ultimately trusted keys found
  gpg: Total number processed: 1
  gpg:               imported: 1

##### Slightly off-topic: The last 64 bits

Here's where I (KajMagnus) found the last 64 bits: https://github.com/openresty/openresty.org/pull/32/files — GitHub user 'dol' wants to merge:

>  All the releases are signed by the public key '[A0E98066](https://pgp.mit.edu/pks/lookup?op=get&search=0xB550E09EA0E98066)'.

This matches the old OpenResty key I already had installed.

Here's an issue in the OpenResty issuetracker about updating the website,
more key bits: https://github.com/openresty/openresty.org/issues/171


#### 3) Verify the OpenResty archive

Now verify the `tar.gz`:

  gpg --verify openresty-1.19.3.1.tar.gz.asc

Should print sth like:

  gpg: assuming signed data in 'openresty-1.19.3.1.tar.gz'
  gpg: Signature made Fri 06 Nov 2020 09:03:29 AM CET
  gpg:                using RSA key B550E09EA0E98066
  gpg: Good signature from "Yichun Zhang (agentzh) <agentzh@gmail.com>" [unknown]
  gpg: WARNING: This key is not certified with a trusted signature!
  gpg:          There is no indication that the signature belongs to the owner.
  Primary key fingerprint: 2545 1EB0 8846 0026 195B  D62C B550 E09E A0E9 8066

Note that the key ends with `B550E09EA0E98066` and is from Yichun Zhang. Since
you haven't signed Yichun's key with a key of your own, GPG logs a warning.


#### 4) Update the source code

Now, move the old `source/` dir, and unzip the new version to `source/`:

  mv source source-old
  git rm -fr source
  tar -xf openresty-1.19.3.1.tar.gz
  mv openresty-1.19.3.1 source
  git add source

Then maybe look at the changes in Git. Delete `source-old/`.


#### 5) Commit, rebuild, test

Commit the changes in this mobule, images/web/openresty/. Then update Ty's main
repo (at `../../../`): `git add` and `commit` this submodule.

Rebuild the web image: `s/tyd rebuild web`
